#!/usr/bin/make -f

ifneq (,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
	NUMJOBS = $(patsubst parallel=%,%,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
endif

ifeq (,$(NUMJOBS))
	NUMJOBS := $(shell getconf _NPROCESSORS_ONLN 2>/dev/null || echo 1)
endif

ifeq ($(NUMJOBS),-1)
	NUMJOBS:=1
endif

ifeq ($(NUMJOBS),0)
	NUMJOBS:=1
endif

ifneq (,$(filter noopt,$(DEB_BUILD_OPTIONS)))
	CFLAGS += -O0
endif

ifneq (,$(filter lzma,$(DEB_BUILD_OPTIONS)))
	BUILDDEBFLAGS= -- -Zlzma -z9
endif

ifneq (,$(filter xz,$(DEB_BUILD_OPTIONS)))
	BUILDDEBFLAGS= -- -Zxz -z9
endif

BUILDDIR = builddir

CMAKEOPTS =	-DCMAKE_BUILD_TYPE=Release \
			-DCMAKE_INSTALL_PREFIX=/usr \
			-DUSE_GTK=ON -DUSE_QT=ON \
            -DUSE_MINIUPNP=ON -DLOCAL_MINIUPNP=ON \
			-DUSE_ASPELL=ON -DFREE_SPACE_BAR_C=ON \
            -DUSE_LIBGNOME2=OFF \
            -DCREATE_MO=ON -DUPDATE_PO=OFF \
            -DLUA_SCRIPT=ON -DWITH_LUASCRIPTS=ON \
            -DWITH_SOUNDS=ON \
			..

CMAKEOPTS_FULL =		-DUSE_WT=ON  -DUSE_JS=ON

CMAKEOPTS_WITHOUT_WT =	-DUSE_WT=OFF -DUSE_JS=ON

CMAKEOPTS_WITHOUT_JS =	-DUSE_WT=OFF -DUSE_JS=OFF

WITHOUT_JS = false

REVISION = $(shell /bin/sh -c "dpkg-parsechangelog | awk '/^Version: / {print $2}' | sed -e 's/^.*svn//' -e 's/-.*//'")
CMAKEOPTS += -DDCPP_REVISION=$(REVISION)


DEBIAN_CODENAME = $(shell echo $$DIST)
ifeq "$(DEBIAN_CODENAME)" ""
	DEBIAN_CODENAME = $(shell dpkg-parsechangelog | awk '/^Distribution: / {print $$2}')
endif

ifeq "$(DEBIAN_CODENAME)" "lucid"
	CONTROL = control.without_wt
	CMAKEOPTS += $(CMAKEOPTS_WITHOUT_WT)
else
ifeq "$(DEBIAN_CODENAME)" "karmic"
	CONTROL = control.without_wt
	CMAKEOPTS += $(CMAKEOPTS_WITHOUT_WT)
else
ifeq "$(DEBIAN_CODENAME)" "jaunty"
	CONTROL = control.without_wt
	CMAKEOPTS += $(CMAKEOPTS_WITHOUT_WT)
else
ifeq "$(DEBIAN_CODENAME)" "intrepid"
	CONTROL = control.without_wt
	CMAKEOPTS += $(CMAKEOPTS_WITHOUT_JS)
	WITHOUT_JS = true
else
ifeq "$(DEBIAN_CODENAME)" "lenny"
	CONTROL = control.without_wt
	CMAKEOPTS += $(CMAKEOPTS_WITHOUT_JS)
	WITHOUT_JS = true
else # basic options
	CONTROL = control.full
	CMAKEOPTS += $(CMAKEOPTS_FULL)
endif
endif
endif
endif
endif

configure: configure-stamp
configure-stamp:
	dh_testdir
	cp debian/$(CONTROL) debian/control
	mkdir -p $(BUILDDIR) && cd $(BUILDDIR) && cmake $(CMAKEOPTS)
	touch $@
build: configure build-stamp
build-stamp:
	dh_testdir
	cd $(BUILDDIR) && $(MAKE) -j$(NUMJOBS)
	touch $@
clean: do-clean
do-clean:
	dh_testdir
	dh_testroot
	cp debian/$(CONTROL) debian/control
	[ ! -f Makefile ] || ( cd $(BUILDDIR) && $(MAKE) clean )
	test ! -d $(BUILDDIR) || rm -r $(BUILDDIR)
	dh_clean
install: build
	dh_testdir
	dh_testroot
	dh_prep
	dh_installdirs
	cd $(BUILDDIR) && $(MAKE) install DESTDIR=$(CURDIR)/debian/tmp
	rm -f debian/tmp/usr/share/eiskaltdcpp/wt/ext/LICENSE.txt
binary-indep: build install
	dh_testdir -i
	dh_testroot -i
	dh_movefiles -i
	dh_installdocs -i
	dh_installchangelogs -i ChangeLog.txt
ifeq "$(WITHOUT_JS)" "true"
	rm -fr debian/eiskaltdcpp-qt-data/usr/share/eiskaltdcpp/qt/qtscripts/
endif
	dh_compress -i
	dh_fixperms -i
	dh_installdeb -i
	dh_gencontrol -i
	dh_md5sums -i
	dh_builddeb -i $(BUILDDEBFLAGS)
binary-arch: build install
	dh_testdir -a
	dh_testroot -a
	dh_movefiles -a
	dh_installchangelogs -a ChangeLog.txt
	dh_installdocs -a
	dh_installman -a
	dh_link -a
ifeq (,$(filter nostrip,$(DEB_BUILD_OPTIONS)))
	dh_strip -a
endif
	dh_compress -a
	dh_fixperms -a
	dh_makeshlibs -plibdcpp2.1.x
	dh_installdeb -a
	dh_shlibdeps -a -ldebian/libdcpp2.1.x/usr/lib
	dh_installdebconf -a
	dh_gencontrol -a
	dh_md5sums -a
	dh_builddeb -a $(BUILDDEBFLAGS)
binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install configure patch unpatch do-clean
