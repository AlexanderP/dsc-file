#!/usr/bin/make -f
# Uncomment this to turn on verbose mode.
#DH_VERBOSE=1

DEBIAN_CODENAME = $(shell echo $$DIST)
ifeq "$(DEBIAN_CODENAME)" ""
	DEBIAN_CODENAME = $(shell dpkg-parsechangelog | awk '/^Distribution: / {print $$2}')
endif

export DEB_CXXFLAGS_MAINT_APPEND = $(shell dpkg-buildflags --get CPPFLAGS)
export DEB_LDFLAGS_MAINT_APPEND = -Wl,--as-needed
export DEB_BUILD_MAINT_OPTIONS = hardening=+all

BUILDDIR1 = $(CURDIR)/debian/builddir1
BUILDDIR2 = $(CURDIR)/debian/builddir2
DESTDIR   = $(CURDIR)/debian/tmp

CMAKEOPTS = -DBUNDLED_IRIS=ON \
            -DUSE_HUNSPELL=ON \
            -DUSE_ENCHANT=OFF \
            -DUSE_KEYCHAIN=ON \
            -DUSE_CCACHE=OFF \
            -DONLY_PLUGINS=OFF \
            -DBUILD_DEV_PLUGINS=OFF \
            -DSEPARATE_QJDNS=OFF \
            -DVERBOSE_PROGRAM_NAME=ON

OPTSSTEP1 = -DENABLE_PLUGINS=ON \
            -DCHAT_TYPE=basic

OPTSSTEP2 = -DENABLE_PLUGINS=OFF \
            -DCHAT_TYPE=webkit

ifneq (,$(filter $(DEBIAN_CODENAME),xenial))
	CMAKEOPTS += -DUSE_KEYCHAIN=OFF
else
	CMAKEOPTS += -DUSE_KEYCHAIN=ON
endif

%:
	dh $@ --buildsystem=cmake --parallel

override_dh_auto_configure:
ifneq (,$(filter $(DEBIAN_CODENAME),stretch xenial artful))
	sed -i '/^    omemoplugin/d' $(CURDIR)/src/plugins/generic/CMakeLists.txt
else
	# no sed
endif
	dh_auto_configure -B$(BUILDDIR1) -- $(CMAKEOPTS) $(OPTSSTEP1)
	dh_auto_configure -B$(BUILDDIR2) -- $(CMAKEOPTS) $(OPTSSTEP2)

override_dh_auto_build:
	dh_auto_build -B$(BUILDDIR1)
	dh_auto_build -B$(BUILDDIR2)

override_dh_auto_test:
	dh_auto_test -B$(BUILDDIR1)
	dh_auto_test -B$(BUILDDIR2)

override_dh_auto_install:
	dh_auto_install -B$(BUILDDIR1) --destdir=$(DESTDIR)
	cp -a $(BUILDDIR2)/psi/psi-plus-webkit $(DESTDIR)/usr/bin/
	cp -a $(CURDIR)/debian/psi-plus*.desktop $(DESTDIR)/usr/share/applications/
	cp -a $(CURDIR)/skins $(DESTDIR)/usr/share/psi-plus/
	cp -a $(CURDIR)/themes $(DESTDIR)/usr/share/psi-plus/
