#!/usr/bin/make -f

export DH_ALWAYS_EXCLUDE := ChangeLog.txt

DEBIAN_CODENAME = $(shell echo $$DIST)
ifeq "$(DEBIAN_CODENAME)" ""
	DEBIAN_CODENAME = $(shell dpkg-parsechangelog | awk '/^Distribution: / {print $$2}')
endif

ifneq (,$(filter $(DEBIAN_CODENAME),lucid karmic)) 
	BUILDDEBFLAGS= -- -Zlzma -z9
else
	BUILDDEBFLAGS= -- -Zxz -z9
endif

ifneq (,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
	NUMJOBS = $(patsubst parallel=%,%,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
endif

ifeq (,$(NUMJOBS))
	NUMJOBS = 1
endif

CPPFLAGS:=$(shell dpkg-buildflags --get CPPFLAGS)
CXXFLAGS:=$(shell dpkg-buildflags --get CXXFLAGS) $(CPPFLAGS)
LDFLAGS:=$(shell dpkg-buildflags --get LDFLAGS) -Wl,--as-needed

BUILDDIR1 = builddir1
BUILDDIR2 = builddir2

DEB_DH_INSTALL_SOURCEDIR = $(CURDIR)/debian/tmp

PACKAGE = eiskaltdcpp

DEBIAN_PATH := $(abspath $(dir $(MAKEFILE_LIST)))
USCAN_REPORT = $(shell uscan --noconf --report --dehs $(DEBIAN_PATH))
CUR_VER = $(shell echo "$(USCAN_REPORT)" | sed -n 's/.*<upstream-version>\(.*\)<\/upstream-version>.*/\1/p')
CUR_URL = $(shell echo "$(USCAN_REPORT)" | sed -n 's/.*<upstream-url>\(.*\)<\/upstream-url>.*/\1/p')

CMAKEOPTS = -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DCMAKE_CXX_FLAGS="$(CXXFLAGS)" \
            -DCMAKE_SHARED_LINKER_FLAGS="$(LDFLAGS)" \
            -DCMAKE_EXE_LINKER_FLAGS="$(LDFLAGS)" \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DUSE_MINIUPNP=ON -DLOCAL_MINIUPNP=OFF \
            -DLUA_SCRIPT=ON -DWITH_LUASCRIPTS=ON \
            -DPERL_REGEX=ON -DWITH_DHT=ON \
            -DWITH_SOUNDS=ON \
            -DUSE_ASPELL=ON -DFREE_SPACE_BAR_C=ON \
            -DCHECK_GTK_DEPRECATED=OFF \
            -DUSE_LIBGNOME2=OFF -DUSE_LIBNOTIFY=ON \
            -DCREATE_MO=ON -DUPDATE_PO=OFF \
            -DNO_UI_DAEMON=ON \
            -DXMLRPC_DAEMON=OFF -DJSONRPC_DAEMON=ON \
            -DUSE_CLI_JSONRPC=ON \
            -DWITH_DEV_FILES=ON \
            -DUSE_IDNA=ON \
            ..

OPTSSTEP1 = -DUSE_QT_SQLITE=ON \
            -DUSE_JS=ON \
            -DUSE_GTK=ON -DUSE_GTK3=OFF

OPTSSTEP2 = -DUSE_QT_SQLITE=OFF \
            -DUSE_JS=OFF \
            -DUSE_GTK=OFF -DUSE_GTK3=ON

# This option is for daily builds of the EiskaltDC++ packages on Launchpad
# See https://launchpad.net/~tehnick/+archive/tehnick for more information
REVISION = $(shell cat debian/changelog |grep '* Commit' | sed 1q |awk -F ': ' '{print $$2}' | cut -c-10)
CMAKEOPTS += -DDCPP_REVISION="$(REVISION)"

ifneq (,$(filter $(DEBIAN_CODENAME),sid stretch buster zesty artful)) 
	CONTROL = control.sid
	export QT_SELECT=qt5
	CMAKEOPTS += -DUSE_QT=OFF -DUSE_QT5=ON
	OPTSSTEP1 += -DUSE_QT_QML=OFF
	OPTSSTEP2 += -DUSE_QT_QML=OFF
else
	CONTROL = control.jessie
	CMAKEOPTS += -DUSE_QT=ON -DUSE_QT5=OFF 
	OPTSSTEP1 += -DUSE_QT_QML=ON
	OPTSSTEP2 += -DUSE_QT_QML=OFF
endif

%:
	dh $@ --parallel

override_dh_auto_configure:
	cp debian/$(CONTROL) debian/control
	mkdir -p $(BUILDDIR1) && cd $(BUILDDIR1) && cmake $(CMAKEOPTS) $(OPTSSTEP1)

override_dh_auto_build:
	cd $(BUILDDIR1) && $(MAKE) -j$(NUMJOBS)
	cp -ra $(BUILDDIR1) $(BUILDDIR2)
	cd $(BUILDDIR2) && find . -type f -iname '*make*' -exec sed -i "s|$(BUILDDIR1)|$(BUILDDIR2)|" {} \;
	cd $(BUILDDIR2) && cmake $(CMAKEOPTS) $(OPTSSTEP2)
	cd $(BUILDDIR2) && $(MAKE) -j$(NUMJOBS)

override_dh_auto_clean:
	cp debian/$(CONTROL) debian/control
	dh_testroot
	[ ! -f Makefile ] || ( cd $(BUILDDIR1) && $(MAKE) clean )
	[ ! -f Makefile ] || ( cd $(BUILDDIR2) && $(MAKE) clean )
	[ ! -d $(BUILDDIR1) ] || rm -r $(BUILDDIR1)
	[ ! -d $(BUILDDIR2) ] || rm -r $(BUILDDIR2)
	rm -f configure-stamp build-stamp

override_dh_auto_install:
	cd $(BUILDDIR1) && $(MAKE) install DESTDIR=$(DEB_DH_INSTALL_SOURCEDIR)
	cp $(CURDIR)/debian/eiskaltdcpp-qt-mini.desktop \
			$(DEB_DH_INSTALL_SOURCEDIR)/usr/share/applications/eiskaltdcpp-qt-mini.desktop
	cp $(BUILDDIR2)/eiskaltdcpp-qt/eiskaltdcpp-qt \
			$(DEB_DH_INSTALL_SOURCEDIR)/usr/bin/eiskaltdcpp-qt-mini
	chrpath -d $(DEB_DH_INSTALL_SOURCEDIR)/usr/bin/eiskaltdcpp-qt-mini
	cp $(BUILDDIR2)/eiskaltdcpp-qt/eiskaltdcpp-qt.1.gz \
			$(DEB_DH_INSTALL_SOURCEDIR)/usr/share/man/man1/eiskaltdcpp-qt-mini.1.gz
	cp $(CURDIR)/debian/eiskaltdcpp-gtk3.desktop \
			$(DEB_DH_INSTALL_SOURCEDIR)/usr/share/applications/eiskaltdcpp-gtk3.desktop
	cp $(BUILDDIR2)/eiskaltdcpp-gtk/eiskaltdcpp-gtk \
			$(DEB_DH_INSTALL_SOURCEDIR)/usr/bin/eiskaltdcpp-gtk3
	chrpath -d $(DEB_DH_INSTALL_SOURCEDIR)/usr/bin/eiskaltdcpp-gtk3
	cp $(BUILDDIR2)/eiskaltdcpp-gtk/eiskaltdcpp-gtk.1.gz \
			$(DEB_DH_INSTALL_SOURCEDIR)/usr/share/man/man1/eiskaltdcpp-gtk3.1.gz

override_dh_install:
	dh_movefiles

override_dh_installchangelogs:
	dh_installchangelogs ChangeLog.txt

.PHONY: override_dh_strip
override_dh_strip:
	dh_strip -Nlibeiskaltdcpp2.3-unstable \
			-Neiskaltdcpp-qt-unstable \
			-Neiskaltdcpp-qt-mini-unstable \
			-Neiskaltdcpp-gtk-unstable \
			-Neiskaltdcpp-gtk3-unstable \
			-Neiskaltdcpp-daemon-unstable
	dh_strip -plibeiskaltdcpp2.3-unstable --dbg-package=libeiskaltdcpp2.3-unstable-dbg
	dh_strip -peiskaltdcpp-qt-unstable --dbg-package=eiskaltdcpp-qt-unstable-dbg
	dh_strip -peiskaltdcpp-qt-mini-unstable --dbg-package=eiskaltdcpp-qt-mini-unstable-dbg
	dh_strip -peiskaltdcpp-gtk-unstable --dbg-package=eiskaltdcpp-gtk-unstable-dbg
	dh_strip -peiskaltdcpp-gtk3-unstable --dbg-package=eiskaltdcpp-gtk3-unstable-dbg
	dh_strip -peiskaltdcpp-daemon-unstable --dbg-package=eiskaltdcpp-daemon-unstable-dbg

.PHONY: override_dh_makeshlibs
override_dh_makeshlibs:
	dh_makeshlibs -V -plibeiskaltdcpp2.3-unstable

.PHONY: override_dh_shlibdeps
override_dh_shlibdeps:
	dh_shlibdeps -a -ldebian/libeiskaltdcpp2.3-unstable/usr/lib
