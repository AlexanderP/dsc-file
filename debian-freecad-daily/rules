#!/usr/bin/make -f
%:
	dh $@ --buildsystem=cmake --parallel --with python3

DEB_BUILD_GNU_TYPE  ?= $(shell dpkg-architecture -qDEB_BUILD_GNU_TYPE)

extra_flags += \
-DBUILD_QT5=ON \
-DFREECAD_BUILD_DEBIAN=ON \
-DCMAKE_CXX_FLAGS="-Wall -DHAVE_SWIG=1 -fpermissive $(shell dpkg-buildflags --get CXXFLAGS) $(shell dpkg-buildflags --get CPPFLAGS)" \
-DCMAKE_C_FLAGS="-Wall -fpermissive $(shell dpkg-buildflags --get CFLAGS) $(shell dpkg-buildflags --get CPPFLAGS)" \
-DCMAKE_SHARED_LINKER_FLAGS="$(shell dpkg-buildflags --get LDFLAGS)" \
-DLIB_SUFFIX="" \
-DCMAKE_INSTALL_PREFIX="/usr/lib/freecad-daily" \
-DCMAKE_INSTALL_DATADIR="/usr/share/freecad-daily" \
-DCMAKE_INSTALL_DOCDIR="/usr/share/doc/freecad-daily-doc" \
-DCMAKE_INSTALL_LIBDIR="/usr/lib/freecad-daily/lib" \
-DBUILD_FEM_NETGEN=OFF \
-DBUILD_FEM_VTK=ON \
-DPYTHON_EXECUTABLE="/usr/bin/python3" \
-DCMAKE_BUILD_TYPE="Release" \
-DOCC_INCLUDE_DIR="/usr/include/opencascade"

override_dh_auto_configure:
ifneq (,$(filter $(DEBIAN_CODENAME),sid bullseye buster disco)) 
	patch -p1 < debian/patches/fix_gcc8_ftbfs.patch
else
	echo "no patch"
endif
	dh_auto_configure -- $(extra_flags)

override_dh_compress:
	dh_compress -X.qch -X.qhc

override_dh_installchangelogs:
	dh_installchangelogs ChangeLog.txt

override_dh_auto_install:
	dh_auto_install --destdir=debian/tmp

override_dh_installmime:
	dh_installmime
	dh_install debian/mime/freecad-daily-thumbnailer usr/bin
	dh_install debian/mime/freecad-daily.thumbnailer usr/share/thumbnailers
	dh_install debian/mime/freecad-daily.schemas etc/gconf/schemas

override_dh_icons:
	install -m 644 debian/tmp/usr/lib/freecad-daily/share/icons/hicolor/16x16/apps/freecad.png debian/freecad-daily/usr/share/icons/hicolor/16x16/apps/freecad-daily.png
	install -m 644 debian/tmp/usr/lib/freecad-daily/share/icons/hicolor/32x32/apps/freecad.png debian/freecad-daily/usr/share/icons/hicolor/32x32/apps/freecad-daily.png
	install -m 644 debian/tmp/usr/lib/freecad-daily/share/icons/hicolor/48x48/apps/freecad.png debian/freecad-daily/usr/share/icons/hicolor/48x48/apps/freecad-daily.png
	install -m 644 debian/tmp/usr/lib/freecad-daily/share/icons/hicolor/64x64/apps/freecad.png debian/freecad-daily/usr/share/icons/hicolor/64x64/apps/freecad-daily.png
	install -m 644 debian/tmp/usr/lib/freecad-daily/share/icons/hicolor/scalable/apps/freecad.svg debian/freecad-daily/usr/share/icons/hicolor/scalable/apps/freecad-daily.svg
